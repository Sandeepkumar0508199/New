# Convert final alerts to JSON for ADF (ADD THIS AT THE VERY END)
try:
    if not allAlerts_df.empty:
        # Convert Spark DataFrame to Pandas, then to JSON
        final_alerts_json = allAlerts_df.toPandas().to_json(orient='records')
        print(f"âœ… Generated {len(allAlerts_df)} Cross Product alerts for output")
        print(f"ğŸ“‹ Sample alert data: {final_alerts_json[:200]}...")
    else:
        final_alerts_json = "[]"
        print("ğŸ“‹ No Cross Product alerts generated")
    
    print("ğŸ¯ Cross Product Detection completed - sending results to ADF")
    dbutils.notebook.exit(final_alerts_json)
    
except Exception as e:
    print(f"âŒ Error preparing output: {e}")
    print("ğŸ“‹ Sending empty result to ADF")
    dbutils.notebook.exit("[]")
